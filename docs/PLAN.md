# 実装計画: Agent Forge

この計画は `agent-forge` CLI ツールの構築手順を概説します。

## Phase 1: スケルトンと CLI 基盤
**目標:** プロジェクト構造を確立し、基本的な CLI エントリーポイントを作成する。

- [ ] **プロジェクトセットアップ:**
    - `pyproject.toml` の依存関係を確認する (`tmuxp`, `libtmux`, CLI用の `click` または `typer`)。
    - `agent_forge/__init__.py` がバージョンを公開しているか確認する。
- [ ] **CLI エントリーポイント (`agent_forge/cli.py`):**
    - `click` を使用して基本的なコマンド構造を実装する。
    - コマンドを定義する: `init`, `start`, `send`, `read`, `list`。
    - ロギング設定をセットアップする。

## Phase 2: Forge ジェネレーター (設定)
**目標:** 宣言的な環境ファイル (`.forge.yaml`) を生成・管理する。

- [ ] **テンプレートエンジン:**
    - `.forge.yaml` 用のデフォルトテンプレートを作成する (標準的な3ペインレイアウト)。
    - `forge init` を実装する:
        - 既存の設定を確認する。
        - 存在しない場合、デフォルト設定を書き込む。
- [ ] **Config ローダー:**
    - `.forge.yaml` を読み込むユーティリティを実装する (`tmuxp.config` のラッパー)。

## Phase 3: コントローラー (ランタイム)
**目標:** `libtmux` を介して tmux セッションを制御するコアロジックを実装する。

- [ ] **セッションマネージャー (`agent_forge/session.py`):**
    - `start_forge(config_path)`: `tmuxp` を使用してセッションをロードする。
    - `find_pane(session, name)`: 名前またはインデックスでペインを特定するヘルパー。
- [ ] **通信プリミティブ (`agent_forge/actions.py`):**
    - `send_command(pane, cmd)`: `send-keys` の実装。
    - `read_output(pane, lines=100)`: `capture-pane` の実装。
    - `broadcast(session, cmd)`: すべてのペインにコマンドを送信する。

## Phase 4: CLI コマンド実装
**目標:** CLI とコントローラーロジックを接続する。

- [ ] **`forge start`:**
    - 設定を検証する。
    - セッションを起動する (フラグに基づいてアタッチまたはデタッチ)。
- [ ] **`forge send <target> <message>`:**
    - 現在のセッションを特定する (コンテキスト認識)。
    - ターゲットペインを見つける。
    - キーを送信する。
- [ ] **`forge read <target>`:**
    - ターゲットペインの最後の N 行をキャプチャして表示する。
- [ ] **`forge list`:**
    - アクティブな Forge セッションとそのペイン/エージェントを一覧表示する。

## Phase 5: エージェントスキルとドキュメント
**目標:** AI エージェントがツールを使用できるようにする。

- [ ] **MCP / ツール定義:**
    - AI コンテキスト用に `forge` コマンドの JSON/Markdown 定義を作成する。
    - "あなたはアーキテクトです。`forge send implementer '...'` を使用して指示してください。"
- [ ] **ワークフロー例:**
    - 2つのエージェントの会話を示すデモスクリプトを作成する。

## Phase 6: テストと改善
**目標:** 信頼性を確保する。

- [ ] **単体テスト:** 実際の tmux サーバーを起動せずにロジックをテストするために、`libtmux` 呼び出しをモックする。
- [ ] **統合テスト:** (オプション/ローカル) 実際の tmux セッションを CI またはローカル環境で実行して検証する。